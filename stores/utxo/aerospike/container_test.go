package aerospike

import (
	"context"
	"fmt"
	"net/url"
	"testing"

	"github.com/bitcoin-sv/ubsv/ulogger"
	"github.com/libsv/go-bt/v2"
	"github.com/stretchr/testify/assert"

	aero "github.com/aerospike/aerospike-client-go/v7"
	aeroTest "github.com/ajeetdsouza/testcontainers-aerospike-go"
	"github.com/bitcoin-sv/ubsv/stores/utxo/meta"
	"github.com/stretchr/testify/require"
)

func TestAerospikeContainer(t *testing.T) {
	aeroClient := setupAerospike(t)
	// your code here

	assert.NotNil(t, aeroClient)
	fmt.Printf("Aerospike client: %v\n", aeroClient)
}

func setupAerospike(t *testing.T) *aero.Client {
	ctx := context.Background()

	container, err := aeroTest.RunContainer(ctx, aeroTest.WithImage("aerospike:ce-6.4.0.7_2"))
	require.NoError(t, err)
	t.Cleanup(func() {
		err := container.Terminate(ctx)
		require.NoError(t, err)
	})

	host, err := container.Host(ctx)
	require.NoError(t, err)
	port, err := container.ServicePort(ctx)
	require.NoError(t, err)

	client, err := aero.NewClient(host, port)
	require.NoError(t, err)

	return client
}

func TestPreviousOutput(t *testing.T) {
	t.Skip("Skipping test that requires Aerospike")
	// Aerospike
	aeroURL, err := url.Parse("aerospike://localhost:3000/test")
	require.NoError(t, err)

	store, err := New(ulogger.TestLogger{}, aeroURL)
	require.NoError(t, err)

	// 75696d1ef2b70f62c0157e7dd9cfef13f4f3ee5fae98cd04e00b1822d26363fa
	previousTx, err := bt.NewTxFromString("010000000000000000ef012d3746b3fa849a901dac83f4ee0bc9f8a0b294e69ee2a216fd0614c49f5aac9b000000008b483045022100b059ea8f390ab16cf2744203a12a4d0a6a85abf62aee68c09164551fc5a9c72e0220324cf2639078a8052b9a533cdd7a53b93cc32b4ecaa5c3326abf651107deef1d01410446ca32230229946b745df0b2a220084f8afd45ca0b40314999c73a84e8bdfcaaa31f60f756e4b4971492de4d4a18e820ad861f9a949ca3bb700ca1f24ddb9110ffffffffb0662ef1000000001976a914cb775ace861ff5e18fb5bfcc848ea7bbb3b347e288ac0230e20ff1000000001976a914ff9baa5b596c5aeedd9c2c41ade6883ffa88bc1f88ac80841e00000000001976a9149131dafa70cc0ac860c08873508c1aa3a72b31a988ac00000000")
	require.NoError(t, err)
	assert.Equal(t, "75696d1ef2b70f62c0157e7dd9cfef13f4f3ee5fae98cd04e00b1822d26363fa", previousTx.TxID())

	// 89c82039452c14a9314b5834e5d2b9241b1fdccdb6e4f4f68e49015540faaf95
	tx, err := bt.NewTxFromString("010000000000000000ef01fa6363d222180be004cd98ae5feef3f413efcfd97d7e15c0620fb7f21e6d6975000000008b483045022100c31fe8e263ae282633d36c761b65ff4a566f09ddf0da201f903a1e6c159b0ac4022074b80000b02ee8578db7522c7d7f7d2044dfa105f56e8fc1e9d27c97a033abd6014104beec61e3acf22e5aa6c97ae354fc65555e26dd444f620d113d7feba7a8815ab15205ee8fec4e13af1777610a91f6b030b072be663db972fe0c394411f0fb2bc1ffffffff30e20ff1000000001976a914ff9baa5b596c5aeedd9c2c41ade6883ffa88bc1f88ac0230d9d2f0000000001976a91470bcb5186044c09e532ddc2914b61c0a2b07876188ac00093d00000000001976a9149a58e9696fe10b44bf2c91b2cb18c2ded593041788ac00000000")
	require.NoError(t, err)
	assert.Equal(t, "89c82039452c14a9314b5834e5d2b9241b1fdccdb6e4f4f68e49015540faaf95", tx.TxID())

	ctx := context.Background()

	err = store.Delete(ctx, previousTx.TxIDChainHash())
	require.NoError(t, err)

	err = store.Delete(ctx, tx.TxIDChainHash())
	require.NoError(t, err)

	_, err = store.Create(ctx, previousTx)
	require.NoError(t, err)

	_, err = store.Create(ctx, tx)
	require.NoError(t, err)

	// Now we can test the previous output

	outpoints := []*meta.PreviousOutput{
		{
			PreviousTxID: *previousTx.TxIDChainHash(),
			Vout:         0,
		},
		{
			PreviousTxID: *tx.TxIDChainHash(),
			Vout:         0,
		},
	}

	// Get the previous output
	err = store.PreviousOutputsDecorate(ctx, outpoints)
	require.NoError(t, err)

	// Check the outpoints
	assert.Len(t, outpoints, 2)
	assert.Equal(t, outpoints[0].Satoshis, previousTx.Outputs[0].Satoshis)
	assert.True(t, previousTx.Outputs[0].LockingScript.EqualsBytes(outpoints[0].LockingScript))
	assert.Equal(t, outpoints[1].Satoshis, tx.Outputs[0].Satoshis)
	assert.True(t, tx.Outputs[0].LockingScript.EqualsBytes(outpoints[1].LockingScript))
}

func TestCreateWith2Outputs(t *testing.T) {
	t.Skip("Skipping test that requires Aerospike")

	aeroURL, err := url.Parse("aerospike://localhost:3000/test")
	require.NoError(t, err)

	store, err := New(ulogger.TestLogger{}, aeroURL)
	require.NoError(t, err)

	tx, err := bt.NewTxFromString("010000000000000000ef01c997a5e56e104102fa209c6a852dd90660a20b2d9c352423edce25857fcd3704000000004847304402204e45e16932b8af514961a1d3a1a25fdf3f4f7732e9d624c6c61548ab5fb8cd410220181522ec8eca07de4860a4acdd12909d831cc56cbbac4622082221a8768d1d0901ffffffff00f2052a0100000043410411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3ac0200ca9a3b00000000434104ae1a62fe09c5f51b13905f07f06b99a2f7159b2225f374cd378d71302fa28414e7aab37397f554a7df5f142c21c1b7303b8a0626f1baded5c72a704f7e6cd84cac00286bee0000000043410411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3ac00000000")
	require.NoError(t, err)

	ctx := context.Background()

	_, err = store.Create(ctx, tx)
	require.NoError(t, err)

}

// func TestXxx(t *testing.T) {

// 	// tx, err := bt.NewTxFromString("0100000006799f85b39bf61dac7dc36bf6c308ae59939418bc130ed759da11294f5ef9aaa6010000008c4930460221009c76c09e958f8e931e4554c67b058f97d69aebe388fe94d10304759d8e479b6f022100fd7170a3433163e6cbd26d72c5a1ef03208fd2f161eec8ed29a3e7375c110e850141048d05eb9a3e0460c9bc53de3d65338759847127478bb7b78f251f35296f6e7e81eb47938e36b13c208bfc0e5db5159283aa38b6bed9471f078358d278add30d6efffffffff74638454462945a25bf31fe6d86af21a9c4f759202d3e5a77af7159e9366d07000000008b4830450221009dce295a412b5e59346f8324489f840d8a4cf091cd937a404ede5741a88b5daa022002141dcef9e0292d633dd6e15887011f95fd93093cdbd6095fe4109ccf8fb3000141048d05eb9a3e0460c9bc53de3d65338759847127478bb7b78f251f35296f6e7e81eb47938e36b13c208bfc0e5db5159283aa38b6bed9471f078358d278add30d6effffffff0d4c9e1044f3b45d1ac0774a611a0671230cfcb7f35a74312292b21e801842be000000008c493046022100c0a288dafa462de48d98dc57ff2122c83438c1a23dd3b02c396edef07fde24fd022100cbd739de346cece8fd7afa045ee734f6c3bd663ac4b8ab22a039e41306bbb2680141048d05eb9a3e0460c9bc53de3d65338759847127478bb7b78f251f35296f6e7e81eb47938e36b13c208bfc0e5db5159283aa38b6bed9471f078358d278add30d6effffffff5873172734313950c64ee7835a66078ea498dffe9a369b8d178c7afcadca1473000000008c493046022100dff57c5672ee29a561be549399a1f7d991d946dac90f0e17271ff1182cdf1cf2022100ac902f98a75e5cd4e7aa9e3f53902c4ae1abbde4bb61f37f8e9b9d7711c0560c0141048d05eb9a3e0460c9bc53de3d65338759847127478bb7b78f251f35296f6e7e81eb47938e36b13c208bfc0e5db5159283aa38b6bed9471f078358d278add30d6effffffff50098179a9cbaa23019a50e4fb13b3f7da468c4656d5b389b2eaa3abce402fdb000000008c493046022100fe83fe49c10b714f0686e08af05ebdedf7906a61e1747141929a999805edf5ba022100a9cb162bfdf4ad9a821443a900e4bddc75acfcaa42a924d43ce7ac672d7f89340141048d05eb9a3e0460c9bc53de3d65338759847127478bb7b78f251f35296f6e7e81eb47938e36b13c208bfc0e5db5159283aa38b6bed9471f078358d278add30d6effffffff91adfcbbca99c0dbf1efbae93d5fed774c420beac17468cbd4d484428b82793b000000008b483045022066b9120a711fa9b75da495b3c50ee5057f4fe476ed5955e8e69aed998429d2f2022100b53715ce6c320c5dfab5eff4bd9d9660159650a9519655ce143f5737fa87562a0141048d05eb9a3e0460c9bc53de3d65338759847127478bb7b78f251f35296f6e7e81eb47938e36b13c208bfc0e5db5159283aa38b6bed9471f078358d278add30d6effffffff0146f41000000000001976a9146194bf3632a3cfca62f397aa94cd30de456e5ab388ac00000000")
// 	tx, err := bt.NewTxFromString("010000000000000000ef06799f85b39bf61dac7dc36bf6c308ae59939418bc130ed759da11294f5ef9aaa6010000008c4930460221009c76c09e958f8e931e4554c67b058f97d69aebe388fe94d10304759d8e479b6f022100fd7170a3433163e6cbd26d72c5a1ef03208fd2f161eec8ed29a3e7375c110e850141048d05eb9a3e0460c9bc53de3d65338759847127478bb7b78f251f35296f6e7e81eb47938e36b13c208bfc0e5db5159283aa38b6bed9471f078358d278add30d6effffffff40420f00000000001976a914dc135692cc0f449107e16210370344326aeb779088acf74638454462945a25bf31fe6d86af21a9c4f759202d3e5a77af7159e9366d07000000008b4830450221009dce295a412b5e59346f8324489f840d8a4cf091cd937a404ede5741a88b5daa022002141dcef9e0292d633dd6e15887011f95fd93093cdbd6095fe4109ccf8fb3000141048d05eb9a3e0460c9bc53de3d65338759847127478bb7b78f251f35296f6e7e81eb47938e36b13c208bfc0e5db5159283aa38b6bed9471f078358d278add30d6effffffff40420f00000000001976a914dc135692cc0f449107e16210370344326aeb779088ac0d4c9e1044f3b45d1ac0774a611a0671230cfcb7f35a74312292b21e801842be000000008c493046022100c0a288dafa462de48d98dc57ff2122c83438c1a23dd3b02c396edef07fde24fd022100cbd739de346cece8fd7afa045ee734f6c3bd663ac4b8ab22a039e41306bbb2680141048d05eb9a3e0460c9bc53de3d65338759847127478bb7b78f251f35296f6e7e81eb47938e36b13c208bfc0e5db5159283aa38b6bed9471f078358d278add30d6effffffff00000000000000001976a914dc135692cc0f449107e16210370344326aeb779088ac5873172734313950c64ee7835a66078ea498dffe9a369b8d178c7afcadca1473000000008c493046022100dff57c5672ee29a561be549399a1f7d991d946dac90f0e17271ff1182cdf1cf2022100ac902f98a75e5cd4e7aa9e3f53902c4ae1abbde4bb61f37f8e9b9d7711c0560c0141048d05eb9a3e0460c9bc53de3d65338759847127478bb7b78f251f35296f6e7e81eb47938e36b13c208bfc0e5db5159283aa38b6bed9471f078358d278add30d6effffffff00000000000000001976a914dc135692cc0f449107e16210370344326aeb779088ac50098179a9cbaa23019a50e4fb13b3f7da468c4656d5b389b2eaa3abce402fdb000000008c493046022100fe83fe49c10b714f0686e08af05ebdedf7906a61e1747141929a999805edf5ba022100a9cb162bfdf4ad9a821443a900e4bddc75acfcaa42a924d43ce7ac672d7f89340141048d05eb9a3e0460c9bc53de3d65338759847127478bb7b78f251f35296f6e7e81eb47938e36b13c208bfc0e5db5159283aa38b6bed9471f078358d278add30d6effffffff00000000000000001976a914dc135692cc0f449107e16210370344326aeb779088ac91adfcbbca99c0dbf1efbae93d5fed774c420beac17468cbd4d484428b82793b000000008b483045022066b9120a711fa9b75da495b3c50ee5057f4fe476ed5955e8e69aed998429d2f2022100b53715ce6c320c5dfab5eff4bd9d9660159650a9519655ce143f5737fa87562a0141048d05eb9a3e0460c9bc53de3d65338759847127478bb7b78f251f35296f6e7e81eb47938e36b13c208bfc0e5db5159283aa38b6bed9471f078358d278add30d6effffffff40420f00000000001976a914dc135692cc0f449107e16210370344326aeb779088ac0146f41000000000001976a9146194bf3632a3cfca62f397aa94cd30de456e5ab388ac00000000")

// 	require.NoError(t, err)

// 	assert.True(t, tx.IsExtended())

// }
