<script lang="ts">
  import { goto } from '$app/navigation'
  import TextInput from '$lib/components/textinput/index.svelte'
  import BreadCrumbs from '$internal/components/breadcrumbs/index.svelte'
  import { success, failure } from '$lib/utils/notifications'
  import { getDetailsUrl } from '$internal/utils/urls'

  import i18n from '$internal/i18n'
  import * as api from '$internal/api'

  export let style = ''

  let searchValue = ''
  let lastSearchCalled = ''

  // TODO(api integration)
  async function onSearchKeyDown(e) {
    if (!e) e = window.event
    const keyCode = e.detail.code || e.detail.key

    if (keyCode === 'Enter') {
      // console.log('call api: search = ', searchValue)
      lastSearchCalled = searchValue
      const result: any = await api.searchItem({ q: searchValue })
      if (result.ok) {
        // success(JSON.stringify(result.data, null, 2))
        const { type, hash } = result.data
        // console.log('Redirecting in 2 seconds..')
        // setTimeout(() => {
        goto(getDetailsUrl(type, hash))
        // }, 2000)
      } else {
        failure(result.error.message)
      }
      return false
    } else if (keyCode === 'Escape') {
      searchValue = ''
      return false
    }
  }
</script>

<div class="toolbar" {style}>
  <div class="left">
    <BreadCrumbs />
  </div>
  <div class="right">
    <TextInput
      name="one"
      size="medium"
      style="--input-size-md-border-radius:8px"
      autocomplete="off"
      bind:value={searchValue}
      width={330}
      focusWidth={570}
      icon={searchValue === lastSearchCalled ? 'icon-search-line' : 'icon-search-solid'}
      placeholder={$i18n.t('comp.toolbar.placeholder')}
      on:keydown={onSearchKeyDown}
    />
  </div>
</div>

<style>
  .toolbar {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .toolbar .left {
    display: flex;
    justify-content: flex-start;
  }

  .toolbar .right {
    display: flex;
    justify-content: flex-end;
    gap: 4px;
  }
</style>
