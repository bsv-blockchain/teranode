# docker file used to build the docker image.
# The build process is now integrated into CICD
# To use: enable the 'build base container image' Workflow (usually disabled), then push a commit to master/staging branch.
# you can authenticate to ecr using this:
# $ aws ecr get-login-password --region eu-north-1 | docker login --username AWS --password-stdin 434394763103.dkr.ecr.eu-north-1.amazonaws.com

FROM ubuntu:noble

ARG TARGETOS
ARG TARGETARCH
ARG GITHUB_SHA

# Install packages
ARG DEBIAN_FRONTEND=noninteractive
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y ca-certificates build-essential gawk bison manpages-dev file curl gnupg wget golang && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install BDK package conditionning on architecture arm or amd
WORKDIR /download
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "x86_64" ]; then \
        wget https://github.com/bitcoin-sv/bdk/releases/download/v1.2.1-beta/bdk-v1.2.1-beta-docker-x86_64-release.tar.gz \
        && tar -xzvf bdk-v1.2.1-beta-docker-x86_64-release.tar.gz \
        && mv bdk-v1.2.1-beta-docker-x86_64-release /usr/local/bdk-v1.2.1 \
        && rm -fR /download/* ; \
    elif [ "$ARCH" = "aarch64" ]; then \
        wget https://github.com/bitcoin-sv/bdk/releases/download/v1.2.1-beta/bdk-v1.2.1-beta-docker-aarch64-release.tar.gz \
        && tar -xzvf bdk-v1.2.1-beta-docker-aarch64-release.tar.gz \
        && mv bdk-v1.2.1-beta-docker-aarch64-release /usr/local/bdk-v1.2.1 \
        && rm -fR /download/* ; \
    else \
        echo "ERROR : unsupported architecture $ARCH"; \
        exit 1; \
    fi

ENV BDK_INSTALL_ROOT=/usr/local/bdk-v1.2.1
ENV CGO_LDFLAGS="-L${BDK_INSTALL_ROOT}/lib -L${BDK_INSTALL_ROOT}/bin"
ENV CGO_CFLAGS="-I${BDK_INSTALL_ROOT}/include/core -I${BDK_INSTALL_ROOT}/include"

# 18 is the latest LTS version of NodeJS
ENV NODE_MAJOR=18

# Add nodesource to apt sources and install nodejs
RUN echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_$NODE_MAJOR.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list &&\
    mkdir -p /etc/apt/keyrings && \
    curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
RUN apt-get update && \
    apt-get install -y nodejs
