x-ubsv-base: &ubsv-base
  image: ubsv:latest
  depends_on:
    - postgres
    - kafka-shared
  networks:
    - ubsv-network
  volumes:
    - ./data/test:/app/data

x-aerospike-base: &aerospike-base
  image: aerospike:ce-6.4.0.7_2
  # mem_limit: 1024m
  networks:
    - ubsv-network
  command: --config-file /etc/aerospike.conf

networks:
  ubsv-network:
    name: ubsv-network-test

services:
  ubsv-builder:
    image: ubsv:latest
    build:
      context: .
      dockerfile: ci.Dockerfile
      args:
        BASE_IMG: 434394763103.dkr.ecr.eu-north-1.amazonaws.com/ubsv:base-build-3fed05f
        RUN_IMG: 434394763103.dkr.ecr.eu-north-1.amazonaws.com/ubsv:base-run-3fed05f
    networks:
      - ubsv-network
    entrypoint: ["pwd"]

  postgres:
    container_name: postgres-test
    image: postgres:latest
    networks:
      - ubsv-network
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: really_strong_password_change_me
      POSTGRES_DB: postgres
    ports:
      - "7432:5432"
    volumes:
      - ./scripts/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./data/test/postgres:/var/lib/postgresql/data
    restart: on-failure
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  kafka-shared:
    container_name: kafka-shared-test
    image: vectorized/redpanda:latest
    mem_limit: 256m
    networks:
      - ubsv-network
    command:
      - redpanda start
      - --smp 1
      - --overprovisioned
      - --node-id 0
      - --kafka-addr PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr PLAINTEXT://kafka-shared:9092
      - --pandaproxy-addr 0.0.0.0:9093
      - --advertise-pandaproxy-addr localhost:9093
    ports:
      - "48081:8081"
      - "49092:9092"
      - "49093:9093"
    volumes:
      - ./data/test/kafka:/var/lib/kafka

  aerospike-1:
    container_name: aerospike-1-test
    <<: *aerospike-base
    image: aerospike:ce-6.4.0.7_2
    networks:
      - ubsv-network
    command: --config-file /etc/aerospike.conf
    ports:
      - "13100:13100"
    volumes:
      - ./deploy/dev/aerospike/aerospike-tc-1.conf:/etc/aerospike.conf
      - ./data/test/aerospike-1/data:/opt/aerospike/data

  aerospike-2:
    container_name: aerospike-2-test
    <<: *aerospike-base
    image: aerospike:ce-6.4.0.7_2
    networks:
      - ubsv-network
    command: --config-file /etc/aerospike.conf
    ports:
      - "13200:13200"
    volumes:
      - ./deploy/dev/aerospike/aerospike-tc-2.conf:/etc/aerospike.conf
      - ./data/test/aerospike-2/data:/opt/aerospike/data

  aerospike-3:
    container_name: aerospike-3-test
    <<: *aerospike-base
    image: aerospike:ce-6.4.0.7_2
    networks:
      - ubsv-network
    command: --config-file /etc/aerospike.conf
    ports:
      - "13300:13300"
    volumes:
      - ./deploy/dev/aerospike/aerospike-tc-3.conf:/etc/aerospike.conf
      - ./data/test/aerospike-3/data:/opt/aerospike/data

  ubsv1:
    <<: *ubsv-base
    container_name: ubsv1-test
    image: ubsv:latest
    depends_on:
      - aerospike-1
      - postgres
      - kafka-shared
    entrypoint: ["/app/wait.sh", "aerospike-1", "13100", "2", "--", "/app/wait.sh", "postgres", "5432", "0", "--", "/app/wait.sh", "kafka-shared", "9092", "0", "--", "/app/ubsv.run", "-miner=1", "-coinbase=1", "-blockpersister=1", "-rpc=1", "-faucet=1"]
    environment:
      SETTINGS_CONTEXT: ${SETTINGS_CONTEXT_1:-docker.ubsv1.test}
      logLevel: "DEBUG"
    ports:
      - "10081-10097:8081-8097"
      - "10099:8099"
      - "11091:9091"
      - "11905:9905"
      - "11292:9292"
    volumes:
      - ./settings_local.conf:/app/settings_local.conf
      - ./data/test/ubsv1/txstore:/app/data/txstore
      - ./data/test/ubsv1/subtreestore:/app/data/subtreestore
      - ./data/test/ubsv1/blockstore:/app/data/blockstore
      - ./data/test/ubsv1/external:/app/data/ubsv1/external

  ubsv2:
    <<: *ubsv-base
    container_name: ubsv2-test
    image: ubsv:latest
    depends_on:
      - aerospike-2
      - postgres
      - kafka-shared
    entrypoint: ["/app/wait.sh", "aerospike-2", "13200", "2", "--", "/app/wait.sh", "postgres", "5432", "0", "--", "/app/wait.sh", "kafka-shared", "9092", "0", "--", "/app/ubsv.run", "-miner=1", "-coinbase=1", "-blockpersister=1", "-rpc=1"]
    environment:
      SETTINGS_CONTEXT: ${SETTINGS_CONTEXT_2:-docker.ubsv2.test}
      logLevel: "DEBUG"
    ports:
      - "12081-12097:8081-8097"
      - "12099:8099"
      - "13091:9091"
      - "13905:9905"
      - "13292:9292"
    volumes:
      - ./settings_local.conf:/app/settings_local.conf
      - ./data/test/ubsv2/txstore:/app/data/txstore
      - ./data/test/ubsv2/subtreestore:/app/data/subtreestore
      - ./data/test/ubsv2/blockstore:/app/data/blockstore
      - ./data/test/ubsv2/external:/app/data/ubsv2/external

  ubsv3:
    <<: *ubsv-base
    container_name: ubsv3-test
    image: ubsv:latest
    depends_on:
      - aerospike-3
      - postgres
      - kafka-shared
    entrypoint: ["/app/wait.sh", "aerospike-3", "13300", "2", "--", "/app/wait.sh", "postgres", "5432", "0", "--", "/app/wait.sh", "kafka-shared", "9092", "0", "--", "/app/ubsv.run", "-miner=1", "-coinbase=1", "-blockpersister=1", "-rpc=1"]
    environment:
      SETTINGS_CONTEXT: ${SETTINGS_CONTEXT_3:-docker.ubsv3.test}
      logLevel: "DEBUG"
      JAEGER_SERVICE_NAME: ubsv-3
      JAEGER_AGENT_HOST: jaeger
      JAEGER_AGENT_PORT: 6831
    ports:
      - "14081-14097:8081-8097"
      - "14099:8099"
      - "15091:9091"
      - "15905:9905"
      - "15292:9292"
    volumes:
      - ./settings_local.conf:/app/settings_local.conf
      - ./data/test/ubsv3/txstore:/app/data/txstore
      - ./data/test/ubsv3/subtreestore:/app/data/subtreestore
      - ./data/test/ubsv3/blockstore:/app/data/blockstore
      - ./data/test/ubsv3/external:/app/data/ubsv3/external

  # prometheus-1:
  #   container_name: prometheus-1-test
  #   image: prom/prometheus:v2.44.0
  #   scale: 0
  #   mem_limit: 64m
  #   ports:
  #     - "16090:9090"
  #   networks:
  #     - ubsv-network
  #   volumes:
  #     - ./deploy/dev/prometheus/prometheus-1.yml:/etc/prometheus/prometheus.yml

  # prometheus-2:
  #   container_name: prometheus-2-test
  #   scale: 0
  #   image: prom/prometheus:v2.44.0
  #   mem_limit: 64m
  #   ports:
  #     - "16091:9090"
  #   networks:
  #     - ubsv-network
  #   volumes:
  #     - ./deploy/dev/prometheus/prometheus-2.yml:/etc/prometheus/prometheus.yml

  # prometheus-3:
  #   container_name: prometheus-3-test
  #   scale: 0
  #   image: prom/prometheus:v2.44.0
  #   mem_limit: 64m
  #   ports:
  #     - "16092:9090"
  #   networks:
  #     - ubsv-network
  #   volumes:
  #     - ./deploy/dev/prometheus/prometheus-3.yml:/etc/prometheus/prometheus.yml
