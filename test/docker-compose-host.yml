x-teranode-base: &teranode-base
  image: 434394763103.dkr.ecr.eu-north-1.amazonaws.com/teranode:latest
  network_mode: "host"
  depends_on:
    - postgres
    - kafka-shared

x-teranode-commands-base: &teranode-commands-base
  image : 434394763103.dkr.ecr.eu-north-1.amazonaws.com/teranode-commands:latest
  network_mode: "host"

x-teranode-coinbase-base: &teranode-coinbase-base
  image : 434394763103.dkr.ecr.eu-north-1.amazonaws.com/teranode-coinbase:latest 
  network_mode: "host"
  depends_on:
    - postgres
    - kafka-shared


x-aerospike-base: &aerospike-base
  image: aerospike:ce-7.2.0.3_1
  network_mode: "host"
  command: --config-file /etc/aerospike.conf

services:

  teranode-builder:
    container_name: teranode-builder
    profiles:
      - teranode1
      - teranode2
      - teranode3
    image: 434394763103.dkr.ecr.eu-north-1.amazonaws.com/teranode:latest
    network_mode: "host"
    build:
      context: ..
      dockerfile: Dockerfile
      args:
        BASE_IMG: 434394763103.dkr.ecr.eu-north-1.amazonaws.com/teranode-base:build-latest
        RUN_IMG: 434394763103.dkr.ecr.eu-north-1.amazonaws.com/teranode-base:run-latest
    entrypoint: [ "pwd" ]

  postgres:
    container_name: postgres
    image: postgres:latest
    network_mode: "host"
    profiles:
      - postgres
      - teranode1
      - teranode2
      - teranode3
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: really_strong_password_change_me
      POSTGRES_DB: postgres
    volumes:
      - ../compose/postgres/update-config.sh:/docker-entrypoint-initdb.d/postgres-update-config.sh
      - ../compose/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
      - ../data/postgres:/var/lib/postgresql/data
    restart: on-failure

  kafka-shared:
    container_name: kafka-shared
    image: redpandadata/redpanda:latest
    network_mode: "host"
    mem_limit: 256m
    profiles:
      - kafka
      - teranode1
      - teranode2
      - teranode3
    command:
      - redpanda start
      - --smp 1
      - --overprovisioned
      - --node-id 0
      - --kafka-addr PLAINTEXT://0.0.0.0:19092
      - --advertise-kafka-addr PLAINTEXT://localhost:19092
      - --pandaproxy-addr 0.0.0.0:9093
      - --advertise-pandaproxy-addr localhost:19093

  teranode1:
    <<: *teranode-base
    container_name: teranode1
    profiles:
      - teranode1
    depends_on:
      postgres:
        condition: service_started
      kafka-shared:
        condition: service_started
      aerospike1:
        condition: service_started
    entrypoint: [ "/app/wait.sh", "localhost", "3100", "2", "--", "/app/wait.sh", "localhost", "15432", "0", "--", "/app/wait.sh", "localhost", "19092", "0", "--", "/app/teranode.run", "-localTestStartFromState=RUNNING" ]
    environment:
      SETTINGS_CONTEXT: "docker.host.teranode1"
      JAEGER_SERVICE_NAME: teranode1
      JAEGER_AGENT_HOST: localhost
      JAEGER_AGENT_PORT: 6831
      logLevel: "DEBUG"
    volumes:
      - ../settings.conf:/app/settings.conf
      - ../data/teranode1/txstore:/app/data/teranode1/txstore
      - ../data/teranode1/subtreestore:/app/data/teranode1/subtreestore
      - ../data/teranode1/blockstore:/app/data/teranode1/blockstore
      - ../data/teranode1/subtree_quorum:/app/data/teranode1/subtree_quorum
      - ../data/teranode1/external:/app/data/teranode1/external
      - ./wait.sh:/app/wait.sh

  teranode2:
    <<: *teranode-base
    container_name: teranode2
    profiles:
      - teranode2
    depends_on:
      postgres:
        condition: service_started
      kafka-shared:
        condition: service_started
      aerospike2:
        condition: service_started
    entrypoint: [ "/app/wait.sh", "localhost", "3200", "2", "--", "/app/wait.sh", "localhost", "15432", "0", "--", "/app/wait.sh", "localhost", "19092", "0", "--", "/app/teranode.run", "-localTestStartFromState=RUNNING"]
    environment:
      SETTINGS_CONTEXT: "docker.host.teranode2"
      JAEGER_SERVICE_NAME: teranode2
      JAEGER_AGENT_HOST: localhost
      JAEGER_AGENT_PORT: 6831
    volumes:
      - ../settings.conf:/app/settings.conf
      - ../data/teranode2/txstore:/app/data/teranode2/txstore
      - ../data/teranode2/subtreestore:/app/data/teranode2/subtreestore
      - ../data/teranode2/blockstore:/app/data/teranode2/blockstore
      - ../data/teranode2/subtree_quorum:/app/data/teranode2/subtree_quorum
      - ../data/teranode2/external:/app/data/teranode2/external
      - ./wait.sh:/app/wait.sh

  teranode3:
    <<: *teranode-base
    container_name: teranode3
    profiles:
      - teranode3
    depends_on:
      postgres:
        condition: service_started
      kafka-shared:
        condition: service_started
      aerospike3:
        condition: service_started
    entrypoint: [ "/app/wait.sh", "localhost", "3300", "2", "--", "/app/wait.sh", "localhost", "15432", "0", "--", "/app/wait.sh", "localhost", "19092", "0", "--", "/app/teranode.run", "-localTestStartFromState=RUNNING" ]
    environment:
      SETTINGS_CONTEXT: "docker.host.teranode3"
      JAEGER_SERVICE_NAME: teranode3
      JAEGER_AGENT_HOST: localhost
      JAEGER_AGENT_PORT: 6831
    volumes:
      - ../settings.conf:/app/settings.conf
      - ../data/teranode3/txstore:/app/data/teranode3/txstore
      - ../data/teranode3/subtreestore:/app/data/teranode3/subtreestore
      - ../data/teranode3/blockstore:/app/data/teranode3/blockstore
      - ../data/teranode3/subtree_quorum:/app/data/teranode3/subtree_quorum
      - ../data/teranode3/external:/app/data/teranode3/external
      - ./wait.sh:/app/wait.sh
  
  aerospike1:
    container_name: aerospike1
    <<: *aerospike-base
    profiles:
      - aerospike1
      - teranode1
    volumes:
      - ../compose/aerospike/aerospike-1.conf:/etc/aerospike.conf
      - ../data/aerospike1/logs:/var/log/aerospike
      - ../data/aerospike1/data:/opt/aerospike/data

  aerospike2:
    container_name: aerospike2
    <<: *aerospike-base
    profiles:
      - aerospike2
      - teranode2
    volumes:
      - ../compose/aerospike/aerospike-2.conf:/etc/aerospike.conf
      - ../data/aerospike2/logs:/var/log/aerospike
      - ../data/aerospike2/data:/opt/aerospike/data

  aerospike3:
    container_name: aerospike3
    <<: *aerospike-base
    profiles:
      - aerospike3
      - teranode3
    volumes:
      - ../compose/aerospike/aerospike-3.conf:/etc/aerospike.conf
      - ../data/aerospike3/logs:/var/log/aerospike
      - ../data/aerospike3/data:/opt/aerospike/data
  
  svnode1:
    container_name: svnode1-${TEST_ID:-default}
    image: bitcoinsv/bitcoin-sv:1.1.0
    platform: linux/amd64
    network_mode: "host"
    profiles:
      - svnode1
    healthcheck:
      test: [ "CMD", "/entrypoint.sh", "bitcoin-cli", "getinfo" ]
    volumes:
      - ./config/svnode-1.conf:/data/bitcoin.conf
      # - ./data/test/${TEST_ID:-default}/svnode1:/data
    command: [ "/entrypoint.sh", "bitcoind"]

  svnode2:
    container_name: svnode2-${TEST_ID:-default}
    image: bitcoinsv/bitcoin-sv:1.1.0
    platform: linux/amd64
    network_mode: "host"
    profiles:
      - svnode2
    healthcheck:
      test: [ "CMD", "/entrypoint.sh", "bitcoin-cli", "getinfo" ]
    volumes:
      - ./config/svnode-2.conf:/data/bitcoin.conf
      # - ./data/test/${TEST_ID:-default}/svnode2:/data
    command: [ "/entrypoint.sh", "bitcoind"]

  svnode3:
    container_name: svnode3-${TEST_ID:-default}
    image: bitcoinsv/bitcoin-sv:1.1.0
    platform: linux/amd64
    network_mode: "host"
    profiles:
      - svnode3
    healthcheck:
      test: [ "CMD", "/entrypoint.sh", "bitcoin-cli", "getinfo" ]
    volumes:
      - ./config/svnode-3.conf:/data/bitcoin.conf
      # - ./data/test/${TEST_ID:-default}/svnode3:/data
    command: [ "/entrypoint.sh", "bitcoind"]
