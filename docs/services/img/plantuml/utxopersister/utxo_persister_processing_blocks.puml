@startuml
title UTXO Persister - Block Processing

participant "UTXO Persister Server" as Server
participant "Blockchain Client" as BlockchainClient
participant "Blockchain Store" as BlockchainStore
participant "UTXOSet" as UTXOSet
participant "Block Store" as BlockStore

activate Server
Server -> Server : trigger(source)
Server -> Server : processNextBlock()

alt using BlockchainStore
    Server -> BlockchainStore : GetBestBlockHeader()
else using BlockchainClient
    Server -> BlockchainClient : GetBestBlockHeader()
end

alt current height is more than 100 blocks behind
    alt using BlockchainStore
        Server -> BlockchainStore : GetBlockHeadersFromHeight()
    else using BlockchainClient
        Server -> BlockchainClient : GetBlockHeadersFromHeight()
    end

    Server -> Server : verifyLastSet()
    Server -> Server : New Consolidator()
    Server -> Consolidator : ConsolidateBlockRange()

    Server -> UTXOSet : GetUTXOSetWithDeletionsMap()
    activate UTXOSet
    UTXOSet -> BlockStore : Get UTXO deletions
    BlockStore --> UTXOSet : UTXO deletions
    UTXOSet --> Server : Return UTXOSet with deletions map
    deactivate UTXOSet

    Server -> UTXOSet : CreateUTXOSet()
    activate UTXOSet
    UTXOSet -> BlockStore : Get previous block's UTXO set
    BlockStore --> UTXOSet : Previous block's UTXO set
    UTXOSet -> UTXOSet : Apply deletions and additions
    UTXOSet -> BlockStore : Write new UTXO set
    UTXOSet --> Server : UTXO set created
    deactivate UTXOSet

    Server -> BlockStore : Delete previous block's UTXOSet (if not skipped)
    Server -> Server : writeLastHeight()
    Server -> Server : Trigger next block processing
else current height is less than 100 blocks behind
    Server -> Server : Wait for more confirmations
end

deactivate Server

left footer Last Modified On: %date("dd-MMM-yyyy")

@enduml
