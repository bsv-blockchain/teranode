@startuml
actor "gRPC Client" as Client
participant "Block Validator\n(Server.go)" as ServerInternal
participant "ValidateBlock\n(BlockValidation.go)" as ValidateBlock
participant "validateBlockSubtrees\n(BlockValidation.go)" as ValidateBlockSubtrees
participant "validateSubtree\n(BlockValidation.go)" as ValidateSubtree
participant "processMissingTransactions\n(BlockValidation.go)" as ProcessMissingTx
participant "blessMissingTransaction\n(BlockValidation.go)" as BlessMissingTx
participant "Tx Validator Service" as TxValidator
participant "TxMetaStore" as TxMetaStore

== Client invokes Block Validator SubTreeFound() function ==
Client -> ServerInternal: SubtreeFound()
activate ServerInternal

ServerInternal -> ValidateSubtree: validateSubtree()
activate ValidateSubtree

ValidateSubtree -> ProcessMissingTx: processMissingTransactions()
activate ProcessMissingTx

loop for each missing transaction
    ProcessMissingTx -> BlessMissingTx: blessMissingTransaction()
    activate BlessMissingTx

    BlessMissingTx -> TxValidator: Validate()
    activate TxValidator
    TxValidator --> BlessMissingTx: Validation Result
    deactivate TxValidator

    BlessMissingTx --> ProcessMissingTx: Transaction Blessed
    deactivate BlessMissingTx
end

ProcessMissingTx -> TxMetaStore: GetMeta()
activate TxMetaStore
TxMetaStore --> ProcessMissingTx: Meta Data
deactivate TxMetaStore

ProcessMissingTx --> ValidateSubtree: Missing Transactions Processed
deactivate ProcessMissingTx

ValidateSubtree --> ServerInternal: Subtree Validated
deactivate ValidateSubtree

ServerInternal --> Client: Response
deactivate ServerInternal

== Block Validator Server triggers catchup() or processBlockFound() functions ==

ServerInternal -> ServerInternal: catchup() or processBlockFound()


ServerInternal -> ValidateBlock: ValidateBlock()
activate ValidateBlock

ValidateBlock -> ValidateBlockSubtrees: validateBlockSubtrees()
activate ValidateBlockSubtrees

ValidateBlockSubtrees -> ValidateSubtree: validateSubtree()
activate ValidateSubtree

ValidateSubtree -> ProcessMissingTx: processMissingTransactions()
activate ProcessMissingTx

loop for each missing transaction
    ProcessMissingTx -> BlessMissingTx: blessMissingTransaction()
    activate BlessMissingTx

    BlessMissingTx -> TxValidator: Validate()
    activate TxValidator
    TxValidator --> BlessMissingTx: Validation Result
    deactivate TxValidator

    BlessMissingTx --> ProcessMissingTx: Transaction Blessed
    deactivate BlessMissingTx
end

ProcessMissingTx -> TxMetaStore: GetMeta()
activate TxMetaStore
TxMetaStore --> ProcessMissingTx: Meta Data
deactivate TxMetaStore

ProcessMissingTx --> ValidateSubtree: Missing Transactions Processed
deactivate ProcessMissingTx

ValidateSubtree --> ValidateBlockSubtrees: Subtree Validated
deactivate ValidateSubtree

ValidateBlockSubtrees --> ValidateBlock: Block Subtrees Validated
deactivate ValidateBlockSubtrees

ValidateBlock --> ServerInternal: Block Validated
deactivate ValidateBlock

left footer Last Modified On: 28-Nov-2023

@enduml
