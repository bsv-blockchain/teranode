@startuml
skinparam backgroundColor #F0F8FF
skinparam defaultFontColor #333333
skinparam arrowColor #666666

' Define borders for all elements
skinparam entity {
  BorderColor #666666
  BackgroundColor #DDDDDD
}

skinparam control {
  BorderColor #666666
  BackgroundColor #DDDDDD
}

skinparam participant {
  BorderColor #666666
  BackgroundColor #DDDDDD
}




participant "HTTP Client" as Client
participant "HTTP Server" as HTTP
participant "PropagationServer" as Server
participant "Tx Store" as TxStore
participant "Kafka Producer" as KafkaProducer
participant "Validator" as ValidationService

activate Server

Server -> HTTP: Setup HTTP handlers
activate HTTP

loop HTTP Request Handling
    Client -> HTTP: POST /tx
    activate Client
    HTTP -> Server: handleStream(w, r)
    activate Server

    loop for each transaction in stream
        Server -> Server: Read transaction data
        Server -> Server: ProcessTransaction(ctx, tx)

        Server -> TxStore: storeTransaction(ctx, tx)
        activate TxStore
        TxStore --> Server: Storage confirmation
        deactivate TxStore

        alt if Kafka Producer is configured
            Server -> KafkaProducer: Send transaction
            activate KafkaProducer
            KafkaProducer --> Server: Confirmation
            deactivate KafkaProducer
        else if direct validation
            Server -> ValidationService: Validate(ctx, tx)
            activate ValidationService
            ValidationService --> Server: ValidationResult
            deactivate ValidationService
        end
    end

    Server --> HTTP: Transactions processed
    deactivate Server
    HTTP -> Client: Response (implicit, as it's a stream)
    deactivate Client
end

deactivate HTTP

left footer Last Modified On: %date("dd-MMM-yyyy")

@enduml
