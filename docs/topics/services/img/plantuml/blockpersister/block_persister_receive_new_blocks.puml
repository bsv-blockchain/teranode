@startuml
participant "Blockchain Service" as Blockchain
participant "Kafka" as Kafka
participant "Block Persister Service" as BlockPersister
database "File Storage" as FileStorage

Blockchain -> Kafka: Emit Kafka Block Notification
Kafka -> BlockPersister: Notify Block Received
BlockPersister -> BlockPersister: blocksFinalHandler(ctx, _, blockBytes)
activate BlockPersister
BlockPersister -> BlockPersister: persistBlock(ctx, hash, blockBytes)
activate BlockPersister
BlockPersister -> BlockPersister: Create UTXODiff for block


BlockPersister -> BlockPersister: Create file for block
BlockPersister -> BlockPersister: Write block header to block file (.block)
BlockPersister -> FileStorage: Persist block file (.block) to storage

loop for each Subtree in the Block
    BlockPersister -> FileStorage: Create subtree file (.subtree)
end

BlockPersister -> FileStorage: Create UTXO Deletions file  (.utxo-deletions)

BlockPersister -> FileStorage: Create UTXO Additions file (.utxo-additions)
deactivate BlockPersister




left footer Last Modified On: %date("dd-MMM-yyyy")

@enduml
