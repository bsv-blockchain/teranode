# Aerospike database configuration file
# This template sets up a multi-node, single namespace developer environment.

# This stanza must come first.
service {
	cluster-name docker
}

logging {
	# Send log messages to stdout
	console {
		context any info
	}
}

network {
	service {
		address any
		port 3000
	}

	heartbeat {
		# mesh is used for environments that do not support multicast
		mode mesh
		# Use address any instead of local to allow external connections
		address any
		port 3002
		interval 150
		timeout 10

		# Define mesh seed addresses for node discovery
		mesh-seed-address-port aerospike 3002
		mesh-seed-address-port aerospike-2 3002
	}

	fabric {
		# Intra-cluster communication port (migrates, replication, etc)
		# Use address any instead of local to allow external connections
		address any
		port 3001
	}
}

namespace utxo-store {
    default-ttl 0                        # Records do not expire by default
    evict-indexes-memory-pct 100         # Never evict indexes - rely on TTL

    nsup-period 10                       # Run NSUP every 10 seconds
    nsup-threads 8                       # Allocate threads for expiration processing
    truncate-threads 8
    transaction-pending-limit 0

    replication-factor 1
    partition-tree-sprigs 1024

    stop-writes-sys-memory-pct 100       # docker SERVER_MEM_ERROR fix: Stop writes if more than 100% of system memory is used

    storage-engine device {
        # for full IBD, direct disk access is preferred
        # device            /dev/nvme2n1  # replace nvme2n1 with your actual disk identifier

        # multiple devices is recommended, max is 640GB per instance
        file              /opt/aerospike/data/utxostore.dat
        filesize          640G

        # for testing purposes you can also define a smaller file
        # file              /opt/aerospike/data/test.dat
        # filesize          100G

        flush-size 128K
        # Post-write cache to reduce I/O pressure (renamed from post-write-queue in v7.1)
        post-write-cache 256
        # Defrag settings - less aggressive to reduce write amplification
        defrag-lwm-pct 50
        defrag-sleep 2000
        # Eviction threshold
        evict-used-pct 70
        # Cache settings
        read-page-cache true
        # Maximum flush delay in milliseconds
        flush-max-ms 1000
    }
}
